import asyncio
import re

from js import window

# --- í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° ---
# ìƒˆë¡œìš´ ì±•í„°ë‚˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•  ë•ŒëŠ” ì´ ë”•ì…”ë„ˆë¦¬ì—ë§Œ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.
TEST_SCENARIOS = {
    0: [
        "ì¼ì–´ë‚˜ê¸°",
        "êµìˆ˜ë‹˜",
        "ë¬¸",
        "ë‘˜ëŸ¬ë³´ê¸°",
        "ë…¼ë¬¸",
        "ì•ˆê²½ì•Œ",
        "ë¬¸",
        "ë²•ì¸ì¹´ë“œ",
        "ë…¼ë¬¸",
        "ì±…ìƒ",
        "ë¬¼ê±´",
        "ë¬¸",
    ],
    1: [
        "ì“°ë ˆê¸°í†µ",
        "ì“°ë ˆê¸°í†µ",
        "ì“°ë ˆê¸°í†µ",
        "ë°•ìŠ¤",
        "ë²•ì¸ì¹´ë“œ + ë°•ìŠ¤",
        "ë²½ë©´",
        "ë²½",
        "ë©”ëª¨",
        "ë²½",
        "ë¹—ìë£¨",
        "ì˜ë¬¸ì˜ ì•¡ì²´",
        "ë°”ë‹¥",
        "ì‹œì•½ì¥",
        "ì»´í“¨í„°",
        "ì»´í“¨í„° : 1234",  # ì‹¤íŒ¨ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
        "ì»´í“¨í„° : 12345678",  # ì„±ê³µ ì¼€ì´ìŠ¤
        "ë¬¸",
        "ì‹œì•½ì¥ : 0815",
        "ì—íƒ„ì˜¬",
        "ì—íƒ„ì˜¬ + ë°”ë‹¥",
        "ë¹—ìë£¨ + ë°”ë‹¥",
        "ì—íƒ„ì˜¬ + ì˜ë¬¸ì˜ ì•¡ì²´",
        "ì²­ì†Œë„êµ¬í•¨",
        "ì‹¤í—˜ìš© ë© ê°€ìš´",
        "ì²­ì†Œë„êµ¬í•¨ + ì—´ì‡ ",
        "ë¹—ìë£¨ + ë°”ë‹¥",
    ],
    2: [
        "MK-II",
        "ì „ì„ ",
        "ì½˜ì„¼íŠ¸",
        "íƒ‘ìŠ¹êµ¬",
        "êµìˆ˜ë‹˜",
        "íƒ‘ìŠ¹êµ¬ + ìŠ¤íŒ¨ë„ˆ",
        "ë²•ì¸ì¹´ë“œ",
        "êµìˆ˜ë‹˜",
        "êµìˆ˜ë‹˜ + ë²•ì¸ì¹´ë“œ",
        "íƒ‘ìŠ¹êµ¬ + ìŠ¤íŒ¨ë„ˆ",
    ],
    3: [
        "ë°”ë‹¤",
        "ëª¨ë˜ì‚¬ì¥",
        "ëª¨ë˜",
        "MK-II",
        "ê³„ê¸°íŒ",
        "í†µì‹ ê¸°",
        "í•˜ëŠ˜",
        "íƒœì–‘",
        "ìŠ¤íŒ¨ë„ˆ",
        "í†µì‹ ê¸° + ìŠ¤íŒ¨ë„ˆ",
    ],
    4: [
        "MK-II",
        "ì•¼ììˆ˜",
        "ì•¼ììˆ˜",
        "ì“°ë ˆê¸° ë”ë¯¸",
        "ì“°ë ˆê¸° ë”ë¯¸",
        "ìŠ¤íŒ¨ë„ˆ",
        "ì•¼ììˆ˜ + ìŠ¤íŒ¨ë„ˆ",
        "ì•¼ììˆ˜ + ìŠ¤íŒ¨ë„ˆ",
        "ìŠ¤íŒ¨ë„ˆ + ì½”ì½”ë„›",
        "ìŠ¤íŒ¨ë„ˆ + ì½”ì½”ë„›",
        "ëª¨ë˜",
        "ë°”ë‹¤",
        "ìˆ² ì…êµ¬",
        "ë‚œíŒŒì„  ì”í•´",
        "ë‚œíŒŒì„  ì”í•´",
        "ì•„ë‹ˆì˜¤",
        "ë‚œíŒŒì„  ì”í•´",
        "ì–´ë¼",
        "ì˜ˆ",
    ],
    5: [
        "ë¨¼ì§€ ì œê±°ì œ",
        "ìŠ¤íŒ¨ë„ˆ",
        "ë¹ˆ í˜íŠ¸ë³‘",
        "ë¹„ë‹",
        "ë‘˜ëŸ¬ë³´ê¸°",
        "ê²©ë²½",
        "ë¹„ìƒ ìºë¹„ë‹›",
        "ì¡°ëª…íƒ„",
        "ê²½ê³ ë¬¸",
        "ì „ì„ ",
        "ê²©ë²½ + ë¨¼ì§€ ì œê±°ì œ",
        "ê²©ë²½ + ì¡°ëª…íƒ„",
        "ê²©ë²½",
        "ê²©ë²½ + ë¨¼ì§€ ì œê±°ì œ",
        "ê²©ë²½",
        "ê²©ë²½ + ìŠ¤íŒ¨ë„ˆ",
        "ì§€í•˜ í†µë¡œ",
        "ì§€í•˜ í†µë¡œ",
        "ì•„ë‹ˆì˜¤",
        "ì§€í•˜ í†µë¡œ",
        "ì˜ˆ",
    ],
    6: [
        "ë‚œíŒŒì„  ì…êµ¬",
        "ë‚œíŒŒì„  ì…êµ¬",
        "ì˜ˆ",
        "íŒŒì´í”„",
        "ì§€í•˜ í†µë¡œ",
        "ì˜ˆ",
        # # 1. íƒìƒ‰ ë° íŒŒë°
        "ë³´ê¸‰í’ˆ",
        "í©ì–´ì§„ ë³´ê¸‰í’ˆ",
        "í•˜ì–€ ê°€ë£¨",
        "ë…¹ìŠ¨ ì–‘ë™ì´",
        "ë¹ˆ í˜íŠ¸ë³‘",
        "ë¹ˆ í˜íŠ¸ë³‘ + í•˜ì–€ ê°€ë£¨",
        "ë…¹ìŠ¨ ì–‘ë™ì´ + í•˜ì–€ ê°€ë£¨",
        "ë‘˜ëŸ¬ë³´ê¸°",
        "ì‚°ì„± ì›…ë©ì´",
        "ì „ì ê¸ˆê³ ",
        "ì†Œë°© ë„ë¼",
        "ì‘ì—…ëŒ€",
        "ì‚°ì„± ì›…ë©ì´ + ì „ë¶„ ê°€ë£¨",
        "ì‚°ì„± ì›…ë©ì´ + ê°€ì„±ì†Œë‹¤ ì–‘ë™ì´",
        "ì‚°ì„± ì›…ë©ì´ + ë¹ˆ í˜íŠ¸ë³‘",
        "ì‚°ì„± ì›…ë©ì´ + ê°€ì„±ì†Œë‹¤ ì–‘ë™ì´",
        "ë‘˜ëŸ¬ë³´ê¸°",
        "ì‘ì—…ëŒ€",
        "ë©€í‹°ë¯¸í„°",
        "ë©”ëª¨",
        "ê±´ì „ì§€ 1",
        "ë°°í„°ë¦¬ ì¼€ì´ìŠ¤",
        "ë°°í„°ë¦¬ ì¼€ì´ìŠ¤ : 123",
        "ë©€í‹°ë¯¸í„° + ê±´ì „ì§€ 1",
        "ê±´ì „ì§€ 1",
        "ë©€í‹°ë¯¸í„° + ê±´ì „ì§€ 2",
        "ë©€í‹°ë¯¸í„° + ê±´ì „ì§€ 3",
        "ë©€í‹°ë¯¸í„° + ê±´ì „ì§€ 4",
        "ë©€í‹°ë¯¸í„° + ê±´ì „ì§€ 5",
        "ì „ì ê¸ˆê³ ",
        "ì „ì ê¸ˆê³  + ë°°í„°ë¦¬ ì¼€ì´ìŠ¤",
        "ë°°í„°ë¦¬ ì¼€ì´ìŠ¤ : 124",
        "ì „ì ê¸ˆê³  + ë°°í„°ë¦¬ íŒ©",  # ì‚°ì—…ìš© ë°°í„°ë¦¬ íšë“
        "ì†Œë°© ë„ë¼",
        "ë…¹ìŠ¨ í´ë¨í”„",
        "ë…¹ìŠ¨ í´ë¨í”„ + ì‚°ì„± ìš©ì•¡ ë³‘",
        "ì‚°ì„± ìš©ì•¡ ë³‘",
        "ì‚°ì„± ìš©ì•¡ ë³‘ + ì „ë¶„ ê°€ë£¨",
        "ì‚°ì„± ì ¤",
        "ì‚°ì„± ì ¤ + ë…¹ìŠ¨ í´ë¨í”„",
        "ì „ì ê¸ˆê³ ",
        "ì£¼ê¸°ìœ¨í‘œ",
        "ì „ì ê¸ˆê³  : 794729",
        "ì „ì ê¸ˆê³ ",
    ],
    7: [
        "ë‚œíŒŒì„  ì…êµ¬",
        "ì˜ˆ",
        "í•´ë³€",
        "í•´ë³€",
        "ì˜ˆ",
        "ì†Œë°© ë„ë¼",
        "ìˆ² ì…êµ¬",
        "ì†Œë°© ë„ë¼ + ìˆ² ì…êµ¬",
        "ìˆ² ì…êµ¬",
        "ì˜ˆ",
    ],
    8: [
        "ìˆ² ì…êµ¬",
        "ìˆ² ì…êµ¬",
        "ì•„ë‹ˆì˜¤",
        "ëŠªì§€ëŒ€",
        "ìƒíƒœ ê´€ì¸¡ì†Œ",
        "ë©êµ´",
        "ë©êµ´ + ì†Œë°© ë„ë¼",
        "ë²½í™”",
        "í™”ë‹¨",
        "ê´€ì°° ì¼ì§€",
        "ê´€ì¸¡ì†Œ ë¬¸",
        "ê´€ì¸¡ì†Œ ë¬¸ : 1218",
        "ê´€ì¸¡ì†Œ ë‚´ë¶€",
        "ê¸´ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ë‚˜ë¬´",
        "ë§ˆì´í¬",
        "ë§ˆì´í¬ + ì‚°ì—…ìš© ë°°í„°ë¦¬",
        "ë§ˆì´í¬ + ìŠ¤íŒ¨ë„ˆ",
        "ë§ˆì´í¬",
        "ë§ˆì´í¬ + ìŠ¤íŒ¨ë„ˆ",
        "ë§ˆì´í¬ + ì‚°ì—…ìš© ë°°í„°ë¦¬",
        "ë§ˆì´í¬ + ì‚°ì—…ìš© ë°°í„°ë¦¬",
        "ë‚˜ë¬´",
        "ë³´ê¸‰í’ˆ ë¡œì»¤",
        "ë§ˆì´í¬",
        "ê¸´ íŒŒì´í”„",
        "ê¸´ íŒŒì´í”„",
        "ê¸´ íŒŒì´í”„",
        "ê¸´ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ê¸´ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ê¸´ íŒŒì´í”„",
        "ì§§ì€ íŒŒì´í”„",
        "ì‚°ì—…ìš© ë°°í„°ë¦¬",
        "ëŠªì§€ëŒ€",
        "ì˜ˆ",
    ],
    9: [
        "ì“°ë ˆê¸° ë”ë¯¸",
        "ì•…ì–´",
        "ìƒíƒœ ê´€ì¸¡ì†Œ",
        "ìƒíƒœ ê´€ì¸¡ì†Œ",
        "ì˜ˆ",
        "ëŠªì§€ëŒ€ë¡œ ê°€ëŠ” ê¸¸",
        "ì˜ˆ",
        "ë‹¤ë¦¬",
        "ë™êµ´",
        "ëŠªë¬¼",
        "ë¹ˆ í˜íŠ¸ë³‘",
        "ë¹„ë‹",
        "ë¹ˆ í˜íŠ¸ë³‘ + ë¹„ë‹",
        "ë¶€ë ¥ ì£¼ë¨¸ë‹ˆ",
        "ë°©ìˆ˜ í…Œì´í”„",
        "ë¶€ë ¥ ì£¼ë¨¸ë‹ˆ + ë°©ìˆ˜ í…Œì´í”„",
        "ë¶€ë ¥ ì¥ì¹˜",
        "ë¶€ë ¥ ì¥ì¹˜ + ëŠì–´ì§„ ë‹¤ë¦¬",
        # ì•…ì–´ í‡´ì¹˜
        "ë…¹ìŠ¨ ì–‘ë™ì´ + ê±°ëŒ€í•œ ì•…ì–´",
        "ë…¹ìŠ¨ ì–‘ë™ì´ + ì—¼ì†Œ ì†Œë…ì œ",
        "ëŠªë¬¼ + ë¹ˆ í˜íŠ¸ë³‘",
        "ëŠªë¬¼ + ë…¹ìŠ¨ ì–‘ë™ì´",
        "ëŠªë¬¼ ë‹´ì€ ì–‘ë™ì´ + ì‹ì´ˆ",
        "ëŠªë¬¼ ë‹´ì€ ì–‘ë™ì´ + ì—¼ì†Œ ì†Œë…ì œ",
        "ì—¼ì†Œ ì–‘ë™ì´",
        "ëŠªë¬¼ + ì•…ì–´",
        "ëŠªë¬¼ + ì—¼ì†Œ ì†Œë…ì œ",
        "ëŠªë¬¼ + ë¹ˆ í˜íŠ¸ë³‘",
        "ì—¼ì†Œ ì–‘ë™ì´ + ì‚°ì—…ìš© ë°°í„°ë¦¬",
        "ëŠªë¬¼ + ì—¼ì†Œ ì–‘ë™ì´",
        "ì—¼ì†Œ ì–‘ë™ì´ + ì‹ì´ˆ",
        "ì—¼ì†Œ ì–‘ë™ì´ + ì•…ì–´",
        "ë…ê°€ìŠ¤ ì–‘ë™ì´",
        "ë…ê°€ìŠ¤ ì–‘ë™ì´ + ì•…ì–´",
        "ëŠì–´ì§„ ë‹¤ë¦¬",
        "ë¶€ë ¥ ì¥ì¹˜ + ëŠì–´ì§„ ë‹¤ë¦¬",
        "ëŠì–´ì§„ ë‹¤ë¦¬",
        "ë™êµ´ ì…êµ¬",
        "ë™êµ´ ì…êµ¬",
        "ì˜ˆ",
    ],
    10: [
        "ì„íšŒë¬¸",
        "ë™êµ´ í™€",
        "ì§§ì€ ëŒ",
        "ì¤‘ê°„ ëŒ",
        "ê¸´ ëŒ",
        "ì„íšŒë¬¸ : 034530",
        "ì„íšŒë¬¸",
        "ë‘˜ëŸ¬ë³´ê¸°",
        "ì„íšŒ íŒ¨ë„",
        "ì´ìƒí•œ ë¬´ëŠ¬",
        "ê¸€ê·€",
        "ë°˜ì¯¤ ë‚¨ì€ ì‹ì´ˆ",
        "ë°˜ì¯¤ ë‚¨ì€ ì‹ì´ˆ + ì„íšŒ íŒ¨ë„",
        "ì„íšŒ íŒ¨ë„ 1ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ 2ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ 3ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ 4ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ 5ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ ë˜ë²„",
        "ì„íšŒ íŒ¨ë„ 2ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ 3ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ 4ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ ë˜ë²„",
        "ì„íšŒ íŒ¨ë„",
        "ì„íšŒ íŒ¨ë„ 1ë²ˆ ì ",
        "ì„íšŒ íŒ¨ë„ ë˜ë²„",
        "ì§€í•˜ ìƒ˜",
        "ì„ì˜ êµ°ì§‘",
        "ì§€í•˜ ìƒ˜",
        "ì„ì˜ êµ°ì§‘ + ìŠ¤íŒ¨ë„ˆ",
        "ì„ì˜ êµ°ì§‘ + ì†Œë°© ë„ë¼",
        "ì„ì˜ ì¡°ê°",
    ],
    11: [
        "ëŠªì§€ëŒ€",
        "ëŠªì§€ëŒ€",
        "ì˜ˆ",
        "ê³ ë¬´ë‚˜ë¬´",
        "êµ¬ë¦¬ì„ ",
        "ê³ ë¬´ë‚˜ë¬´ + êµ¬ë¦¬ì„ ",
        "ì½”ì½”ë„› ê»ì§ˆ",
        "ê³ ë¬´ë‚˜ë¬´ + ì½”ì½”ë„› ê»ì§ˆ",
        "ì†Œë°© ë„ë¼ + ê³ ë¬´ë‚˜ë¬´",
        "ê³ ë¬´ë‚˜ë¬´ + êµ¬ë¦¬ì„ ",
        "ê³ ë¬´ë‚˜ë¬´ + ì½”ì½”ë„› ê»ì§ˆ",
        "ì ˆì—° êµ¬ë¦¬ì„ ",
        "ì½”íŒ…ëœ ì½”ì½”ë„› ê»ì§ˆ",
        "ë™êµ´ ì…êµ¬",
        "ì˜ˆ",
        "ì§€í•˜ í˜¸ìˆ˜ í†µë¡œ",
        "ì˜ˆ",
    ],
    12: [
        "ê²½ì‚¬ë¡œ",
    ],
}


class TestRunner:
    def __init__(self):
        self.game = None

    def set_game(self, game):
        """Game ê°ì²´ë¥¼ ì„¤ì •í•˜ì—¬ ìˆœí™˜ ì°¸ì¡°ë¥¼ í•´ê²°í•©ë‹ˆë‹¤."""
        self.game = game

    async def run_test_command(self, command: str) -> bool:
        """
        'test'ë¡œ ì‹œì‘í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ íŒŒì‹±í•˜ì—¬ í•´ë‹¹ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        - `test0`: 0ë²ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        - `test0-2`: 0ë²ˆë¶€í„° 2ë²ˆê¹Œì§€ ìˆœì°¨ ì‹¤í–‰
        """
        # 1. ì‹¤í–‰ í™˜ê²½ ë° ëª…ë ¹ì–´ ì²´í¬
        if "localhost" not in window.location.hostname or not command.startswith("test"):
            return False

        if not self.game:
            print("TestRunner Error: Game object is not set.")
            return False

        # 2. ì •ê·œì‹ì„ ì´ìš©í•œ ëª…ë ¹ì–´ íŒŒì‹± (ì˜ˆ: test0, test0-2)
        match = re.match(r"test(\d+)(?:-(\d+))?", command)
        if not match:
            return False

        start_idx = int(match.group(1))
        end_idx = int(match.group(2)) if match.group(2) else start_idx

        # 3. ìœ íš¨ì„± ê²€ì‚¬
        if not self._is_valid_range(start_idx, end_idx):
            max_idx = max(TEST_SCENARIOS.keys()) if TEST_SCENARIOS else 0
            self.game.ui.print_system_message(f"ì˜¤ë¥˜: ìœ íš¨í•˜ì§€ ì•Šì€ í…ŒìŠ¤íŠ¸ ë²”ìœ„ì…ë‹ˆë‹¤. (ê°€ëŠ¥ ë²”ìœ„: 0-{max_idx})")
            return True

        # 4. ì‹œë‚˜ë¦¬ì˜¤ ìˆœì°¨ ì‹¤í–‰
        self.game.ui.print_system_message(f"ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œì‘: {command}")

        for i in range(start_idx, end_idx + 1):
            await self._run_scenario(i)

        self.game.ui.print_system_message(f"âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ: {command}")
        return True

    def _is_valid_range(self, start: int, end: int) -> bool:
        """ì…ë ¥ëœ ë²”ìœ„ê°€ ìœ íš¨í•œì§€ í™•ì¸í•©ë‹ˆë‹¤."""
        return start in TEST_SCENARIOS and end in TEST_SCENARIOS and start <= end

    async def _run_scenario(self, scenario_id: int):
        """íŠ¹ì • IDì˜ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."""
        commands = TEST_SCENARIOS.get(scenario_id)
        if not commands:
            return

        self.game.ui.print_system_message(f"--- Scene {scenario_id} Test Start ---")

        for cmd in commands:
            # ë”œë ˆì´ë¥¼ ì£¼ì–´ ë„ˆë¬´ ë¹ ë¥´ê²Œ ì§€ë‚˜ê°€ëŠ” ê²ƒì„ ë°©ì§€
            await asyncio.sleep(0.01)
            await self.game.process_command(cmd)
